# Clase 4 ‚Äî Integraci√≥n avanzada con JWT y Passport

> **Meta:** migramos de autenticaci√≥n con **sesiones (stateful)** a **JWT (stateless)** usando **cookies HttpOnly firmadas**, estrategias **Passport Local + JwtStrategy**, y **Handlebars** para visualizar el flujo (login ‚Üí current ‚Üí logout). Este README resume **qu√© implementamos**, **c√≥mo est√° organizado el proyecto** y **c√≥mo probar todo**.

---

## üéØ Objetivos de la clase

- Integrar lo visto (Express, Mongo, rutas y middlewares) en un ejemplo funcional.
- Aplicar **JWT desde cookie HttpOnly firmada** (emisi√≥n, transporte, validaci√≥n).
- Comprender **Passport**: `LocalStrategy` (credenciales) y `JwtStrategy` (token).
- Reforzar **stateful vs stateless**, **XSS/CSRF**, **401 vs 403**, y **roles**.
- Incorporar **Handlebars** para un flujo web m√≠nimo.

---

## ‚öôÔ∏è Requisitos

- Node.js 18+  
- MongoDB Atlas (o local)
- Postman

Instalar dependencias:

```bash
npm i
# Dependencias clave de la clase
npm i express mongoose passport passport-local passport-jwt jsonwebtoken cookie-parser helmet cors morgan express-handlebars bcrypt
# (si tu entorno no compila m√≥dulos nativos, pod√©s usar bcryptjs en lugar de bcrypt)

```

## Archivo .env (ejemplo m√≠nimo):
```
MONGO_URI=<tu cadena de conexi√≥n>
MONGO_DB=integrative_practice
PORT=3000
NODE_ENV=development

JWT_SECRET=super_secreto_unico
JWT_EXPIRES=15m
COOKIE_SECRET=otra_clave_para_firmar
COOKIE_NAME=currentUser
```

# Si ten√©s front en otro origen:
# CORS_ORIGIN=http://localhost:5173

## üìÅ Estructura del proyecto
```
/public
  /css
    app.css                # Estilos globales (no inline)

/src
  /config
    passport.js            # Estrategias Local y JWT + init (stateless)
  /middlewares
    auth.js                # requireAuth (passport-jwt)
    roles.js               # allowRoles('admin', ...)
    auth-cookie.js         # Inyecta req.user decodificando cookie JWT (para vistas SSR)
    error.js               # Handler centralizado de errores
  /models
    User.js                # Modelo con hash en pre('save') + comparePassword
  /routes
    sessions.routes.js     # register, login, login-web, current, logout, logout-web
    protected.routes.js    # /private/ping (auth), /private/admin-ping (auth+rol)
    views.routes.js        # /login y /current (SSR con Handlebars)
  /views
    login.handlebars       # Formulario de login (POST ‚Üí login-web)
    current.handlebars     # Muestra email/rol/id y bot√≥n ‚ÄúSalir‚Äù

  app.js                   # App Express (helmet, cors, cookies firmadas, HBS, rutas)
server.js                  # Bootstrap: conexi√≥n Mongo y arranque HTTP
.env                       # Variables de entorno

```

## Qu√© implementamos en esta clase (resumen)

- Autenticaci√≥n stateless con JWT: el servidor no guarda sesiones; cada request llega con un token firmado (JWT_SECRET) que contiene sub, email, role y exp.

- Cookie HttpOnly firmada para transportar el JWT:

- HttpOnly: el JS del navegador no puede leerla (mitiga XSS).

- Firmada con COOKIE_SECRET: si es manipulada, no valida.

- SameSite='lax' en dev; si hay front en otro dominio, usar SameSite='none' + secure:true con HTTPS.


- Passport:

- LocalStrategy: valida credenciales (email + password) contra DB.

- JwtStrategy: valida token (desde Authorization: Bearer y/o cookie firmada) y setea req.user.

- Autorizaci√≥n por roles con middleware allowRoles.

- Vistas con Handlebars para visualizar el flujo desde navegador: login ‚Üí current ‚Üí logout.

## üß† Conceptos clave

- Stateful vs Stateless:

- Stateful (sesiones): el server guarda el estado por usuario.

- Stateless (JWT): el estado viaja en el token; el server s√≥lo verifica firma/exp.

- 401 vs 403:

- 401: no autenticado (token ausente/ inv√°lido / vencido).

- 403: autenticado pero sin permiso (rol no autorizado).

- XSS/CSRF:

- HttpOnly protege contra robo de token por XSS.

- SameSite ayuda a mitigar CSRF (la mayor√≠a de flujos).

## Piezas principales (mapa r√°pido a archivos)

### 1) Modelo de usuario con hash
```
/src/models/User.js
```
- Hash en pre('save') con bcrypt.
- M√©todo comparePassword(plain) para el login.

### 2) Passport ‚Äî estrategias
```
/src/config/passport.js
```

- Local: valida credenciales; retorna { id, email, role }.

- JWT: extrae token de Bearer y cookie firmada; rellena req.user.

### 3) Rutas de sesi√≥n (API + Web)

```
/src/routes/sessions.routes.js
```

POST /api/sessions/register ‚Üí crea user (hash en modelo).

POST /api/sessions/login ‚Üí Local ‚Üí firma JWT ‚Üí Set-Cookie (HttpOnly, signed) ‚Üí { ok:true }.

POST /api/sessions/login-web ‚Üí igual, pero redirige a /current.

GET /api/sessions/current ‚Üí requireAuth (JWT) ‚Üí { user }.

POST /api/sessions/logout y /api/sessions/logout-web ‚Üí limpian cookie.

### 4) Rutas protegidas

```
/src/routes/protected.routes.js
```

GET /private/ping ‚Üí requiere auth.

GET /private/admin-ping ‚Üí requiere auth + rol admin.

### 5) Vistas + SSR

```
/src/routes/views.routes.js, /src/views/*, /src/middlewares/auth-cookie.js
```

GET /login ‚Üí formulario.

POST /api/sessions/login-web ‚Üí cookie JWT ‚Üí redirige /current.

GET /current ‚Üí server decodifica cookie (attachUserFromCookie) y renderiza datos del usuario.


## ‚ñ∂Ô∏è Correr el proyecto

```
npm run dev
# o
node server.js
```

### Verificar:

```
GET http://localhost:3000/health  ‚Üí  { "ok": true }
```

## Gu√≠a de pruebas

### Postman (API con cookies habilitadas)

#### 1. Register

- POST /api/sessions/register

Body (JSON):

```
{ "first_name":"Ada", "last_name":"Lovelace", "age":28, "email":"ada@test.com", "password":"secret" }
```


- Esperado: 201 { ok: true, id: "..." }

#### 2. Login (API)

- POST /api/sessions/login

- Body (JSON):

 ```
{ "email":"ada@test.com", "password":"secret" }
```


- Esperado: 200 { ok:true } y Set-Cookie: currentUser (HttpOnly, signed)
- Tips:
- Dej√° habilitado el ‚Äúcookie jar‚Äù en Postman.
- Si no ves la cookie, revis√° SameSite/secure.

#### 3. Current (API)

- GET /api/sessions/current
- Esperado: 200 { "user": { "id":"...", "email":"ada@test.com", "role":"user" } }

#### 4. Rutas protegidas

- GET /private/ping ‚Üí 200 (logueado) / 401 (sin cookie)
- GET /private/admin-ping
- Con usuario com√∫n ‚Üí 403
- Con admin (ej.: admincoder@coder.com / adminCod3r123) ‚Üí 200

#### 5. Logout (API)

- POST /api/sessions/logout ‚Üí 200, elimina cookie.

## Navegador (flujo web con Handlebars)

1. Ir a http://localhost:3000/login

2. Completar form ‚Üí env√≠a POST /api/sessions/login-web

3. Redirige a /current ‚Üí se muestran email/rol/id

4. Bot√≥n ‚ÄúSalir‚Äù ‚Üí POST /api/sessions/logout-web ‚Üí redirige a /login



| Tema          | Clase 3 (Sesiones)                         | Clase 4 (JWT)                                        |
| ------------- | ------------------------------------------ | ---------------------------------------------------- |
| Estado        | **Stateful** (server guarda sesi√≥n)        | **Stateless** (token con firma/exp por request)      |
| Transporte    | Cookie legible por server                  | **Cookie HttpOnly firmada** (no la lee JS)           |
| Passport      | `LocalStrategy`                            | `LocalStrategy` + `JwtStrategy`                      |
| Seguridad     | Dependiente de store/rotaci√≥n              | **HttpOnly/SameSite/Secure** + expiraci√≥n JWT        |
| Autorizaci√≥n  | B√°sica                                     | **Roles** con `allowRoles()`                         |
| Escalabilidad | Requiere compartir sesi√≥n entre instancias | **M√°s simple** (no hay store), ideal para horizontal |
| Logout        | Destruye sesi√≥n                            | Borrar cookie (client-side)                          |
| 401 vs 403    | Menos expl√≠cito                            | 401 sin token / 403 sin permiso                      |


## Cierre (qu√© cambia respecto a clases previas)

- Migramos de sesiones a JWT en cookie HttpOnly firmada, entendiendo por qu√© (escalabilidad, despliegue, seguridad) y c√≥mo (emisi√≥n/validaci√≥n).

- Integramos Passport Local + JwtStrategy para separar validaci√≥n de credenciales de validaci√≥n de identidad en cada request.

- Implementamos roles y vistas para observar el flujo completo.

- Este stack es la base para agregar OAuth (GitHub/Google), refresh tokens y frontends SPA.

## Notas finales

- En producci√≥n, activar secure: true (HTTPS) y SameSite: 'none'.

- Si el front vive en otro dominio, configurar CORS_ORIGIN y credentials: true.

- Si tu entorno no compila bcrypt, us√° bcryptjs y ajust√° m√©todos hash/compare.